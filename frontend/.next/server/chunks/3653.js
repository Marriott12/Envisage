"use strict";exports.id=3653,exports.ids=[3653],exports.modules={3653:(e,t,s)=>{s.d(t,{a:()=>useAuth});var o=s(9885),r=s(7114),a=s(8551),n=s(345);let i=a.Z.create({baseURL:"http://localhost/Envisage/backend/public/api",headers:{"Content-Type":"application/json",Accept:"application/json"}});let TokenStorage=class TokenStorage{static{this.TOKEN_KEY="envisage_auth_token"}static{this.REFRESH_KEY="envisage_refresh_token"}static{this.EXPIRES_KEY="envisage_token_expires"}static setToken(e,t){if(localStorage.setItem(this.TOKEN_KEY,e),t){let e=Date.now()+1e3*t;localStorage.setItem(this.EXPIRES_KEY,e.toString())}}static getToken(){let e=localStorage.getItem(this.TOKEN_KEY),t=localStorage.getItem(this.EXPIRES_KEY);return e&&t&&Date.now()>parseInt(t)?(this.removeToken(),null):e}static removeToken(){localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.REFRESH_KEY),localStorage.removeItem(this.EXPIRES_KEY)}static isTokenExpired(){let e=localStorage.getItem(this.EXPIRES_KEY);return!!e&&Date.now()>parseInt(e)}};i.interceptors.request.use(e=>{let t=TokenStorage.getToken();return t&&(e.headers.Authorization=`Bearer ${t}`),e}),i.interceptors.response.use(e=>e,e=>(e.response?.status===401&&(TokenStorage.removeToken(),window.location.href="/login"),Promise.reject(e)));let useAuth=()=>{let[e,t]=(0,o.useState)(null),[s,a]=(0,o.useState)(!0),l=(0,r.useRouter)(),c=!!e&&!!TokenStorage.getToken(),u=(0,o.useCallback)(async()=>{try{let e=TokenStorage.getToken();if(!e)return null;let s=await i.get("/user",{headers:{Authorization:`Bearer ${e}`}}),o=s.data;return t(o),o}catch(e){return console.error("Failed to get user:",e),(e.response?.status===401||e.response?.status===404)&&(TokenStorage.removeToken(),t(null)),null}},[]);(0,o.useEffect)(()=>{let initializeAuth=async()=>{let e=TokenStorage.getToken();if(e&&!TokenStorage.isTokenExpired())try{await u()}catch(e){console.error("Failed to initialize auth:",e),TokenStorage.removeToken()}a(!1)};initializeAuth()},[u]);let g=(0,o.useCallback)(async e=>{try{a(!0);let s=await i.post("/login",e),{access_token:o,user:r}=s.data;if(o)return TokenStorage.setToken(o),t(r),n.toast.success(`Welcome back, ${r.name}!`),{success:!0,message:"Login successful",user:r};return n.toast.error("Login failed - no token received"),{success:!1,message:"Login failed"}}catch(t){console.error("âŒ Login error:",t);let e=t.response?.data?.message||"Login failed. Please check your credentials.";return n.toast.error(e),{success:!1,message:e}}finally{a(!1)}},[]),k=(0,o.useCallback)(async e=>{try{a(!0);let s=await i.post("/register",e),{access_token:o,user:r}=s.data;if(o&&r)return TokenStorage.setToken(o),t(r),n.toast.success(`Welcome to Envisage, ${r.name}!`),{success:!0,message:"Registration successful",user:r};return n.toast.error("Registration failed - no token received"),{success:!1,message:"Registration failed"}}catch(t){console.error("Registration error:",t);let e=t.response?.data?.message||"Registration failed. Please try again.";return n.toast.error(e),{success:!1,message:e}}finally{a(!1)}},[]),T=(0,o.useCallback)(async()=>{try{let e=TokenStorage.getToken();await i.post("/logout",{},{headers:{Authorization:`Bearer ${e}`}})}catch(e){console.error("Logout request failed:",e)}finally{TokenStorage.removeToken(),t(null),n.toast.success("Logged out successfully"),l.push("/")}},[l]),h=(0,o.useCallback)(async()=>{try{let e=await i.post("/auth/refresh"),{status:s,data:o}=e.data;if("success"===s&&o)return TokenStorage.setToken(o.token,o.expires_in),t(o.user),!0;return!1}catch(e){return console.error("Token refresh failed:",e),TokenStorage.removeToken(),t(null),!1}},[]);return(0,o.useEffect)(()=>{if(!c)return;let e=setInterval(async()=>{let e=TokenStorage.getToken();if(e&&TokenStorage.isTokenExpired()){let e=await h();e||l.push("/login")}},3e5);return()=>clearInterval(e)},[c,h,l]),{user:e,isAuthenticated:c,isLoading:s,login:g,register:k,logout:T,getUser:u,refreshToken:h}}}};